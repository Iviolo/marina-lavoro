<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<title>Gestione Lavoro, Guardia, Recupero, Straordinario e Forfettario - Marina Militare</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap');
  body {
    font-family: 'Poppins', sans-serif;
    background: linear-gradient(135deg, #e0f0ff, #c8e0ff);
    color: #002D62;
    margin: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
    min-height: 100vh;
  }
  header {
    position: relative;
    width: 90%;
    max-width: 900px;
    padding: 70px 20px 40px;
    margin-bottom: 20px;
    background-color: #004080;
    border-radius: 15px;
    box-shadow: 0 10px 25px rgba(0,0,60,0.3);
    color: white;
    font-weight: 700;
    font-size: 2.6em;
    text-align: center;
    font-family: 'Poppins', sans-serif;
    overflow: hidden;
  }
  header::before {
    content: "";
    position: absolute;
    inset: 0;
    background: url('https://upload.wikimedia.org/wikipedia/commons/thumb/5/5e/MarinaMilitare_Emblem.svg/512px-MarinaMilitare_Emblem.svg.png') center center no-repeat;
    background-size: 200px 200px;
    opacity: 0.12;
    pointer-events: none;
    z-index: 0;
    filter: drop-shadow(0 0 10px rgba(0, 0, 0, 0.3));
  }
  header > * {
    position: relative;
    z-index: 1;
  }
  main {
    width: 90%;
    max-width: 900px;
    background: white;
    padding: 30px 30px 35px;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
  }
  #meseAnno {
    font-size: 1.9em;
    font-weight: 700;
    margin-bottom: 28px;
    text-align: center;
    color: #003366;
  }
  label {
    font-weight: 600;
    margin-right: 12px;
    font-size: 1em;
  }
  input[type="text"], input[type="number"], select {
    padding: 8px 12px;
    margin-right: 16px;
    border-radius: 7px;
    border: 1.5px solid #99bce4;
    font-size: 1em;
    outline: none;
    transition: border-color 0.3s ease;
  }
  input[type="text"]:focus, input[type="number"]:focus, select:focus {
    border-color: #004080;
  }
  button {
    background-color: #0056b3;
    color: white;
    border: none;
    padding: 11px 24px;
    font-weight: 700;
    font-size: 1.1em;
    border-radius: 8px;
    cursor: pointer;
    box-shadow: 0 5px 15px rgba(0,86,179,0.3);
    transition: background-color 0.3s ease, box-shadow 0.3s ease;
  }
  button:hover {
    background-color: #003d7a;
    box-shadow: 0 8px 20px rgba(0,61,122,0.5);
  }
  h3 {
    color: #002D62;
    font-weight: 700;
    font-size: 1.3em;
    margin-top: 40px;
    margin-bottom: 12px;
    letter-spacing: 0.05em;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
    font-size: 0.95em;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  }
  th, td {
    border: 1.2px solid #b0c4de;
    padding: 14px 12px;
    text-align: center;
  }
  th {
    background-color: #004080;
    color: white;
    font-weight: 700;
  }
  tbody tr:hover {
    background-color: #f0f8ff;
    transition: background-color 0.3s ease;
  }
  #totali {
    margin-top: 22px;
    font-weight: 700;
    font-size: 1.25em;
    text-align: center;
    color: #003366;
  }
  #calendario {
    margin-top: 40px;
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 14px;
  }
  .giorno {
    background: #fdfefe;
    border-radius: 10px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    cursor: default;
    min-height: 95px;
    padding: 12px 10px;
    position: relative;
    user-select: none;
    transition: box-shadow 0.3s ease;
  }
  .giorno:hover {
    box-shadow: 0 6px 18px rgba(0,54,107,0.3);
  }
  .giorno.inactive {
    background-color: #e8eaed;
    color: #a0a8b3;
  }
  .numeroGiorno {
    font-weight: 700;
    font-size: 1.18em;
    margin-bottom: 10px;
    color: #003366;
  }
  .pallino {
    width: 15px;
    height: 15px;
    margin-right: 5px;
    border-radius: 50%;
    display: inline-block;
  }
  .lavoro { background-color: #8b4513; }
  .guardia { background-color: #b22222; }
  .recupero { background-color: #228b22; }
  .straordinario { background-color: #1e90ff; }
  .gf { background-color: #ffa500; }
</style>
</head>
<body>

<header>
  Gestione Lavoro, Guardia, Recupero, Straordinario e Forfettario - Marina Militare
</header>

<main>

  <div id="meseAnno"></div>

  <div id="oreResidueContainer">
    <label for="oreResidueInput">Ore residue guardia iniziali:</label>
    <input type="number" id="oreResidueInput" min="0" step="0.5" value="0" />
    <button onclick="aggiornaOreResidue()">Aggiorna</button>
  </div>

  <label for="dataInput">Data (aaaa-mm-gg):</label>
  <input type="text" id="dataInput" maxlength="10" pattern="\d{4}-\d{2}-\d{2}" placeholder="2025-09-23" />

  <label for="tipoSelect">Tipo attività:</label>
  <select id="tipoSelect">
    <option value="lavoro">Lavoro</option>
    <option value="guardia">Guardia</option>
    <option value="recupero">Recupero Psicofisico</option>
    <option value="straordinario">Straordinario</option>
  </select>

  <div id="inputStraordinarioContainer" style="display:none; margin-top:10px;">
    <label for="oreStraordInput">Ore straordinario:</label>
    <input type="number" id="oreStraordInput" min="0" step="0.5" value="0" />
  </div>

  <button onclick="aggiungiGiorno()">Aggiungi</button>

  <h3>Giornate Registrate</h3>
  <table id="tabellaGiornate">
    <thead>
      <tr>
        <th>Data</th>
        <th>Tipo</th>
        <th>Ore Recupero</th>
        <th>GF</th>
        <th>Forfettario (&euro;)</th>
        <th>Ore Straordinario</th>
        <th>Elimina</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <p id="totali">
    Ore Recupero totali: 0 | Giorni GF: 0 | Forfettario totale: 0&nbsp;&euro; | Ore Straordinario: 0
  </p>

  <div id="calendario"></div>
</main>

<script>
const meseNomi = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio',
  'Giugno', 'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];

let dati = [];
let dataCorrente = new Date();
let oreResidueGuardia = 0;

// Mostra/nasconde input ore straordinario in base a tipo attività
document.getElementById('tipoSelect').addEventListener('change', () => {
  const val = document.getElementById('tipoSelect').value;
  document.getElementById('inputStraordinarioContainer').style.display = val === 'straordinario' ? 'block' : 'none';
});

// Aggiorna ore residue impostate dall’utente
function aggiornaOreResidue() {
  let oreVal = parseFloat(document.getElementById('oreResidueInput').value);
  if (isNaN(oreVal) || oreVal < 0) {
    alert('Inserisci un numero valido per le ore residue!');
    return;
  }
  oreResidueGuardia = oreVal;
  salvaDati();
  aggiornaTabella();
}

// Mostra mese e anno in alto
function mostraMeseAnno() {
  const mese = meseNomi[dataCorrente.getMonth()];
  const anno = dataCorrente.getFullYear();
  document.getElementById('meseAnno').textContent = `${mese} ${anno}`;
}

// Calcola parametri per guardia
function calcolaGuardia(dataString) {
  const [anno, mese, giorno] = dataString.split('-');
  const d = new Date(anno, parseInt(mese) - 1, giorno);
  const giornoSettimana = d.getDay();
  let oreRecupero = 0;
  let gf = 0;
  let forfettario = 0;
  if (giornoSettimana >= 1 && giornoSettimana <= 4) {
    oreRecupero = 8; forfettario = 30;
  } else if (giornoSettimana === 5) {
    oreRecupero = 12; forfettario = 30;
  } else if (giornoSettimana === 0 || giornoSettimana === 6) {
    oreRecupero = 8; gf = 1; forfettario = 90;
  }
  return { oreRecupero, gf, forfettario };
}

function aggiungiGiorno() {
  const dataInput = document.getElementById('dataInput').value;

  // Verifica formato robusto
  if (!/^\d{4}-\d{2}-\d{2}$/.test(dataInput)) {
    alert('Inserisci la data nel formato corretto: aaaa-mm-gg (Es: 2025-09-23)');
    return;
  }

  const tipoSelect = document.getElementById('tipoSelect').value;
  const oreStraordInput = parseFloat(document.getElementById('oreStraordInput').value) || 0;

  if (tipoSelect === 'straordinario' && oreStraordInput <= 0) {
    alert('Inserisci ore straordinario maggiori di zero!');
    return;
  }

  let entry = {  dataInput, tipo: tipoSelect, oreRecupero: 0, gf: 0, forfettario: 0, oreStraordinario: 0 };

  if (tipoSelect === "guardia") {
    const params = calcolaGuardia(dataInput);
    entry.oreRecupero = params.oreRecupero;
    entry.gf = params.gf;
    entry.forfettario = params.forfettario;
  } else if (tipoSelect === "straordinario") {
    entry.oreStraordinario = oreStraordInput;
  }

  if (dati.some(g => g.data === entry.data && g.tipo === entry.tipo)) {
    if (tipoSelect === "straordinario") {
      const idx = dati.findIndex(g => g.data === entry.data && g.tipo === entry.tipo);
      dati[idx].oreStraordinario += entry.oreStraordinario;
      salvaDati();
      aggiornaTabella();
      creaCalendario();
      resetForm();
      return;
    } else {
      alert('Giornata già registrata per questa data e tipo.');
      return;
    }
  }

  dati.push(entry);
  salvaDati();
  aggiornaTabella();
  creaCalendario();
  resetForm();
}

function eliminaGiorno(idx) {
  dati.splice(idx, 1);
  salvaDati();
  aggiornaTabella();
  creaCalendario();
}

function aggiornaTabella() {
  const tbody = document.querySelector('#tabellaGiornate tbody');
  tbody.innerHTML = '';

  let totOreRecupero = 0, totGF = 0, totForfettario = 0, totOreStraordinario = 0;
  dati.forEach((g, idx) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${g.data}</td>
      <td>${g.tipo}</td>
      <td>${g.oreRecupero}</td>
      <td>${g.gf}</td>
      <td>${g.forfettario}</td>
      <td>${g.oreStraordinario || 0}</td>
      <td><button onclick="eliminaGiorno(${idx})">Elimina</button></td>
    `;
    tbody.appendChild(tr);

    totOreRecupero += g.oreRecupero;
    totGF += g.gf;
    totForfettario += g.forfettario;
    totOreStraordinario += g.oreStraordinario || 0;
  });

  const oreFinaliGuardia = oreResidueGuardia + totOreRecupero;

  document.getElementById('totali').textContent =
    `Ore Recupero totali: ${oreFinaliGuardia} (incluse residue: ${oreResidueGuardia}) | Giorni GF: ${totGF} | Forfettario totale: ${totForfettario} € | Ore Straordinario: ${totOreStraordinario}`;
}

function creaCalendario() {
  const calendario = document.getElementById('calendario');
  calendario.innerHTML = '';
  const anno = dataCorrente.getFullYear();
  const mese = dataCorrente.getMonth();
  const primoGiorno = new Date(anno, mese, 1).getDay();
  const giorniMese = new Date(anno, mese + 1, 0).getDate();
  let offset = primoGiorno === 0 ? 6 : primoGiorno -1;

  for (let i=0; i<offset; i++) {
    const cellaVuota = document.createElement('div');
    cellaVuota.classList.add('giorno','inactive');
    calendario.appendChild(cellaVuota);
  }

  for (let giorno=1; giorno<=giorniMese; giorno++) {
    const divGiorno = document.createElement('div');
    divGiorno.classList.add('giorno');
    const dataString = `${anno}-${String(mese+1).padStart(2,'0')}-${String(giorno).padStart(2,'0')}`;
    const numeroGiorno = document.createElement('div');
    numeroGiorno.classList.add('numeroGiorno');
    numeroGiorno.textContent = giorno;
    divGiorno.appendChild(numeroGiorno);

    const attivitaGiorno = dati.filter(d => d.data === dataString);

    attivitaGiorno.forEach(a => {
      const pallino = document.createElement('span');
      pallino.classList.add('pallino');
      if (a.tipo === 'lavoro') pallino.classList.add('lavoro');
      else if (a.tipo === 'guardia') pallino.classList.add('guardia');
      else if (a.tipo === 'recupero') pallino.classList.add('recupero');
      else if (a.tipo === 'straordinario') pallino.classList.add('straordinario');
      if (a.gf) pallino.classList.add('gf');
      divGiorno.appendChild(pallino);
    });

    calendario.appendChild(divGiorno);
  }
}

function salvaDati() {
  localStorage.setItem('giornate2025', JSON.stringify(dati));
  localStorage.setItem('oreResidueGuardia', oreResidueGuardia);
}
function caricaDati() {
  dati = JSON.parse(localStorage.getItem('giornate2025')) || [];
  oreResidueGuardia = parseFloat(localStorage.getItem('oreResidueGuardia')) || 0;
  document.getElementById('oreResidueInput').value = oreResidueGuardia;
}

function resetForm() {
  document.getElementById('dataInput').value = '';
  document.getElementById('tipoSelect').value = 'lavoro';
  document.getElementById('oreStraordInput').value = 0;
}

window.onload = () => {
  caricaDati();
  mostraMeseAnno();
  aggiornaTabella();
  creaCalendario();
};
</script>
</body>
</html>
