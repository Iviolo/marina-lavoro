<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<title>Gestione Lavoro, Guardia, Recupero, Straordinario e Forfettario - Marina Militare</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Roboto&display=swap');
  body {
    font-family: 'Roboto', sans-serif;
    background-color: #f0f4f8;
    color: #003366;
    margin: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  header {
    width: 90%;
    max-width: 900px;
    text-align: center;
    margin-bottom: 10px;
    position: relative;
    padding: 40px 20px 10px;
    color: white;
    font-weight: 700;
    font-size: 2.4em;
    background: url('https://upload.wikimedia.org/wikipedia/commons/thumb/5/5e/MarinaMilitare_Emblem.svg/250px-MarinaMilitare_Emblem.svg.png') no-repeat center bottom;
    background-size: 150px 150px;
    background-color: #003366;
    border-radius: 10px;
    box-shadow: 0 0 15px rgba(0,0,0,0.3);
  }
  main {
    width: 90%;
    max-width: 900px;
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
  }
  #meseAnno {
    font-size: 1.8em;
    font-weight: 700;
    margin-bottom: 20px;
    text-align: center;
  }
  label { margin-right: 8px; font-weight: 600; }
  input[type="date"], input[type="number"], select {
    padding: 6px;
    margin-right: 15px;
    border-radius: 4px;
    border: 1px solid #ccc;
    width: auto;
  }
  button {
    padding: 8px 15px;
    background-color: #00539C;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-weight: 600;
    margin-top: 10px;
  }
  button:hover { background-color: #003D66; }
  table {
    border-collapse: collapse;
    margin-top: 20px;
    width: 100%;
    background: white;
    font-size: 0.9em;
  }
  th, td {
    border: 1px solid #ddd;
    padding: 10px;
    text-align: center;
  }
  th { background-color: #00539C; color: white; }
  #totali {
    margin-top: 15px;
    font-weight: 700;
    font-size: 1.2em;
    text-align: center;
  }
  #calendario {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 8px;
    margin-top: 30px;
  }
  .giorno {
    border: 1px solid #ccc;
    border-radius: 6px;
    padding: 8px;
    height: 90px;
    position: relative;
    cursor: pointer;
    user-select: none;
    background: #f8fbfd;
  }
  .giorno.inactive {
    background-color: #eee;
    color: #999;
  }
  .numeroGiorno {
    font-weight: 700;
    font-size: 1.1em;
    margin-bottom: 5px;
  }
  .pallino {
    width: 14px;
    height: 14px;
    border-radius: 50%;
    display: inline-block;
    margin: 2px 3px;
  }
  .lavoro { background-color: #8B4513; }       /* Marrone */
  .guardia { background-color: #B22222; }      /* Rosso */
  .recupero { background-color: #228B22; }     /* Verde */
  .straordinario { background-color: #1E90FF; }/* Blu */
  .gf { background-color: #FFA500; }           /* Arancione */
</style>
</head>
<body>

<header>
  Gestione Lavoro, Guardia, Recupero, Straordinario e Forfettario - Marina Militare
</header>

<main>
  <div id="meseAnno"></div>

  <label for="dataInput">Seleziona </label>
  <input type="date" id="dataInput" />

  <label for="tipoSelect">Tipo attività:</label>
  <select id="tipoSelect">
    <option value="lavoro">Lavoro</option>
    <option value="guardia">Guardia</option>
    <option value="recupero">Recupero Psicofisico</option>
    <option value="straordinario">Straordinario</option>
  </select>

  <div id="inputStraordinarioContainer" style="display:none; margin-top:10px;">
    <label for="oreStraordInput">Ore straordinario:</label>
    <input type="number" id="oreStraordInput" min="0" step="0.5" value="0" />
  </div>

  <button onclick="aggiungiGiorno()">Aggiungi</button>

  <h3>Giornate Registrate</h3>
  <table id="tabellaGiornate">
    <thead>
      <tr>
        <th>Data</th>
        <th>Tipo</th>
        <th>Ore Recupero</th>
        <th>GF</th>
        <th>Forfettario (&euro;)</th>
        <th>Ore Straordinario</th>
        <th>Elimina</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <p id="totali">
    Ore Recupero totali: 0 | Giorni GF: 0 | Forfettario totale: 0&nbsp;&euro; | Ore Straordinario: 0
  </p>

  <div id="calendario"></div>
</main>

<script>
const meseNomi = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio',
  'Giugno', 'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];

let dati = [];
let dataCorrente = new Date();

// Mostra o nasconde input ore straordinario in base a tipo attività
document.getElementById('tipoSelect').addEventListener('change', () => {
  const val = document.getElementById('tipoSelect').value;
  document.getElementById('inputStraordinarioContainer').style.display = val === 'straordinario' ? 'block' : 'none';
});

// Mostra il mese e anno
function mostraMeseAnno() {
  const mese = meseNomi[dataCorrente.getMonth()];
  const anno = dataCorrente.getFullYear();
  document.getElementById('meseAnno').textContent = `${mese} ${anno}`;
}

// Calcolo guardia specifico con parsing sicuro della data
function calcolaGuardia(dataString) {
  const [anno, mese, giorno] = dataString.split('-');
  const d = new Date(anno, parseInt(mese) - 1, giorno);
  const giornoSettimana = d.getDay();
  let oreRecupero = 0, gf = 0, forfettario = 0;
  if (giornoSettimana >= 1 && giornoSettimana <= 4) {
    oreRecupero = 8; forfettario = 30;
  } else if (giornoSettimana === 5) {
    oreRecupero = 12; forfettario = 30;
  } else if (giornoSettimana === 0 || giornoSettimana === 6) {
    oreRecupero = 8; gf = 1; forfettario = 90;
  }
  return { oreRecupero, gf, forfettario };
}

function aggiungiGiorno() {
  const dataInput = document.getElementById('dataInput').value;
  const tipoSelect = document.getElementById('tipoSelect').value;
  const oreStraordInput = parseFloat(document.getElementById('oreStraordInput').value) || 0;

  if (!dataInput) {
    alert("Seleziona una data!");
    return;
  }

  if (tipoSelect === 'straordinario' && oreStraordInput <= 0) {
    alert('Inserisci ore straordinario maggiori di zero!');
    return;
  }

  let entry = { dataInput, tipo: tipoSelect, oreRecupero: 0, gf: 0, forfettario: 0, oreStraordinario: 0};

  if (tipoSelect === "guardia") {
    const params = calcolaGuardia(dataInput);
    entry.oreRecupero = params.oreRecupero;
    entry.gf = params.gf;
    entry.forfettario = params.forfettario;
  } else if (tipoSelect === "straordinario") {
    entry.oreStraordinario = oreStraordInput;
  }

  if (dati.some(g => g.data === entry.data && g.tipo === entry.tipo)) {
    if (tipoSelect === "straordinario") {
      // Se già esiste straordinario in quella data, somma le ore
      const idx = dati.findIndex(g => g.data === entry.data && g.tipo === entry.tipo);
      dati[idx].oreStraordinario += entry.oreStraordinario;
      salvaDati();
      aggiornaTabella();
      creaCalendario();
      resetForm();
      return;
    } else {
      alert('Giornata già registrata per questa data e tipo.');
      return;
    }
  }

  dati.push(entry);
  salvaDati();
  aggiornaTabella();
  creaCalendario();
  resetForm();
}

function eliminaGiorno(idx) {
  dati.splice(idx, 1);
  salvaDati();
  aggiornaTabella();
  creaCalendario();
}

function aggiornaTabella() {
  const tbody = document.querySelector('#tabellaGiornate tbody');
  tbody.innerHTML = '';

  let totOreRecupero = 0, totGF = 0, totForfettario = 0, totOreStraordinario = 0;
  dati.forEach((g, idx) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${g.data}</td>
      <td>${g.tipo}</td>
      <td>${g.oreRecupero}</td>
      <td>${g.gf}</td>
      <td>${g.forfettario}</td>
      <td>${g.oreStraordinario || 0}</td>
      <td><button onclick="eliminaGiorno(${idx})">Elimina</button></td>
    `;
    tbody.appendChild(tr);

    totOreRecupero += g.oreRecupero;
    totGF += g.gf;
    totForfettario += g.forfettario;
    totOreStraordinario += g.oreStraordinario || 0;
  });

  document.getElementById('totali').textContent =
    `Ore Recupero totali: ${totOreRecupero} | Giorni GF: ${totGF} | Forfettario totale: ${totForfettario} € | Ore Straordinario: ${totOreStraordinario}`;
}

// Funzione per creare calendario con pallini colorati
function creaCalendario() {
  const calendario = document.getElementById('calendario');
  calendario.innerHTML = '';
  const anno = dataCorrente.getFullYear();
  const mese = dataCorrente.getMonth();
  const primoGiorno = new Date(anno, mese, 1).getDay();
  const giorniMese = new Date(anno, mese + 1, 0).getDate();
  let offset = primoGiorno === 0 ? 6 : primoGiorno -1;

  for (let i=0; i<offset; i++) {
    const cellaVuota = document.createElement('div');
    cellaVuota.classList.add('giorno','inactive');
    calendario.appendChild(cellaVuota);
  }

  for (let giorno=1; giorno<=giorniMese; giorno++) {
    const divGiorno = document.createElement('div');
    divGiorno.classList.add('giorno');
    const dataString = `${anno}-${String(mese+1).padStart(2,'0')}-${String(giorno).padStart(2,'0')}`;
    const numeroGiorno = document.createElement('div');
    numeroGiorno.classList.add('numeroGiorno');
    numeroGiorno.textContent = giorno;
    divGiorno.appendChild(numeroGiorno);

    const attivitaGiorno = dati.filter(d => d.data === dataString);

    attivitaGiorno.forEach(a => {
      const pallino = document.createElement('span');
      pallino.classList.add('pallino');
      if (a.tipo === 'lavoro') pallino.classList.add('lavoro');
      else if (a.tipo === 'guardia') pallino.classList.add('guardia');
      else if (a.tipo === 'recupero') pallino.classList.add('recupero');
      else if (a.tipo === 'straordinario') pallino.classList.add('straordinario');
      if (a.gf) pallino.classList.add('gf');
      divGiorno.appendChild(pallino);
    });

    calendario.appendChild(divGiorno);
  }
}

function salvaDati() {
  localStorage.setItem('giornate2025', JSON.stringify(dati));
}
function caricaDati() {
  dati = JSON.parse(localStorage.getItem('giornate2025')) || [];
}

function resetForm() {
  document.getElementById('dataInput').value = '';
  document.getElementById('tipoSelect').value = 'lavoro';
  document.getElementById('oreStraordInput').value = 0;
}

window.onload = () => {
  caricaDati();
  mostraMeseAnno();
  aggiornaTabella();
  creaCalendario();
};
</script>
</body>
</html>
